export default `"use strict";(()=>{var c=(a,s,e)=>new Promise((o,t)=>{var l=n=>{try{i(e.next(n))}catch(d){t(d)}},r=n=>{try{i(e.throw(n))}catch(d){t(d)}},i=n=>n.done?o(n.value):Promise.resolve(n.value).then(l,r);i((e=e.apply(a,s)).next())});var A="realtime-bpm-processor";function m(t){return c(this,arguments,function*(a,s=.2,e=.95,o=.05){let l=e;do if(l-=o,yield a(l))break;while(l>s)})}function v(a=.2,s=.95,e=.05){let o={},t=s;do t-=e,o[t.toString()]=[];while(t>a);return o}function b(a=.2,s=.95,e=.05){let o={},t=s;do t-=e,o[t.toString()]=0;while(t>a);return o}function f(){let s=0,e=new Float32Array(0);function o(){s=0,e=new Float32Array(0)}function t(){return s===4096}function l(){o()}return function(r){t()&&l();let i=new Float32Array(e.length+r.length);return i.set(e,0),i.set(r,e.length),e=i,s+=r.length,{isBufferFull:t(),buffer:e,bufferSize:4096}}}function I(a,s,e=0,o=1e4){let t=[],{length:l}=a;for(let r=e;r<l;r+=1)a[r]>s&&(t.push(r),r+=o);return{peaks:t,threshold:s}}function B(o,t){return c(this,arguments,function*(a,s,e=.2){let l=15,r=!1,i=e;if(yield m(n=>c(this,null,function*(){return r?!0:typeof a[n]=="undefined"?(console.warn("valid peaks does not contains the threshold",n,Object.keys(a).length),!1):(a[n].length>l&&(r=!0,i=n),!1)}),e),r&&i){let n=w(a[i]),d=S(s,n);return{bpm:F(d),threshold:i}}return{bpm:[],threshold:i}})}function F(a,s=5){return a.sort((e,o)=>o.count-e.count).splice(0,s)}function w(a){let s=[];for(let e=0;e<a.length;e++)for(let o=0;o<10;o++){let t=a[e],l=e+o,r=a[l]-t;if(!s.some(n=>n.interval===r?(n.count+=1,n.count):!1)){let n={interval:r,count:1};s.push(n)}}return s}function S(a,s){let e=[];for(let o of s){if(o.interval===0)continue;o.interval=Math.abs(o.interval);let t=60/(o.interval/a);for(;t<90;)t*=2;for(;t>180;)t/=2;if(t=Math.round(t),!e.some(r=>r.tempo===t?(r.count+=o.count,r.count):!1)){let r={tempo:t,count:o.count,confidence:0};e.push(r)}}return e}var u={minValidThreshold:()=>.2,validPeaks:()=>v(),nextIndexPeaks:()=>b(),skipIndexes:()=>1,effectiveBufferTime:()=>0},g=class{constructor(){this.options={continuousAnalysis:!1,stabilizationTime:2e4,muteTimeInIndexes:1e4,debug:!1};this.minValidThreshold=u.minValidThreshold();this.validPeaks=u.validPeaks();this.nextIndexPeaks=u.nextIndexPeaks();this.skipIndexes=u.skipIndexes();this.effectiveBufferTime=u.effectiveBufferTime();this.lastTopBpmCandidate=void 0;this.topBpmCandidateCount=0;this.computedStabilizationTimeInSeconds=0;this.updateComputedValues()}setAsyncConfiguration(s){Object.assign(this.options,s),this.updateComputedValues()}updateComputedValues(){this.computedStabilizationTimeInSeconds=this.options.stabilizationTime/1e3}reset(){this.minValidThreshold=u.minValidThreshold(),this.validPeaks=u.validPeaks(),this.nextIndexPeaks=u.nextIndexPeaks(),this.skipIndexes=u.skipIndexes(),this.effectiveBufferTime=u.effectiveBufferTime()}clearValidPeaks(s){return c(this,null,function*(){console.log("clearValidPeaks prev",this.minValidThreshold),this.minValidThreshold=Number.parseFloat(s.toFixed(2)),console.log("clearValidPeaks new",this.minValidThreshold),yield m(e=>c(this,null,function*(){return e<s&&(console.log("clearValidPeaks at",e),console.log("clearValidPeaks",typeof this.validPeaks[e]),delete this.validPeaks[e],delete this.nextIndexPeaks[e]),!1}))})}analyzeChunck(s,e,o,t){return c(this,null,function*(){console.log("analyzeChunck"),this.options.debug&&t({message:"ANALYZE_CHUNK",data:s}),this.effectiveBufferTime+=o;let l=o*this.skipIndexes,r=l-o;yield this.findPeaks(s,o,r,l,t),this.skipIndexes++;let i=yield B(this.validPeaks,e,this.minValidThreshold),{threshold:n}=i;if(t({message:"BPM",result:i}),i.bpm.length>0){let d=i.bpm[0].tempo;this.lastTopBpmCandidate===d?this.topBpmCandidateCount++:(this.topBpmCandidateCount=1,this.lastTopBpmCandidate=d)}this.minValidThreshold<n&&(t({message:"BPM_STABLE",result:i}),yield this.clearValidPeaks(n)),this.options.continuousAnalysis&&this.effectiveBufferTime/e>this.computedStabilizationTimeInSeconds&&(this.reset(),t({message:"ANALYZER_RESETED"}))})}findPeaks(s,e,o,t,l){return c(this,null,function*(){yield m(r=>c(this,null,function*(){if(this.nextIndexPeaks[r]>=t)return!1;let i=this.nextIndexPeaks[r]%e,{peaks:n,threshold:d}=I(s,r,i);if(n.length===0)return!1;for(let x of n){let h=o+x;this.nextIndexPeaks[d]=h+this.options.muteTimeInIndexes,this.validPeaks[d].push(h),this.options.debug&&l({message:"VALID_PEAK",data:{threshold:d,index:h}})}return!1}),this.minValidThreshold)})}};var y=class extends AudioWorkletProcessor{constructor(){super();this.realTimeBpmAnalyzer=new g;this.stopped=!1;this.aggregate=f(),this.port.addEventListener("message",this.onMessage.bind(this)),this.port.start()}onMessage(e){e.data.message==="ASYNC_CONFIGURATION"&&(console.log("[processor.onMessage] ASYNC_CONFIGURATION"),this.realTimeBpmAnalyzer.setAsyncConfiguration(e.data.parameters)),e.data.message==="RESET"&&(console.log("[processor.onMessage] RESET"),this.aggregate=f(),this.stopped=!1,this.realTimeBpmAnalyzer.reset()),e.data.message==="STOP"&&(console.log("[processor.onMessage] STOP"),this.aggregate=f(),this.stopped=!0,this.realTimeBpmAnalyzer.reset())}process(e,o,t){let l=e[0][0];if(this.stopped||!l)return!0;let{isBufferFull:r,buffer:i,bufferSize:n}=this.aggregate(l);return r&&this.realTimeBpmAnalyzer.analyzeChunck(i,sampleRate,n,d=>{this.port.postMessage(d)}).catch(d=>{console.error(d)}),!0}};registerProcessor(A,y);var K={};})();
//# sourceMappingURL=realtime-bpm-processor.js.map
`;
